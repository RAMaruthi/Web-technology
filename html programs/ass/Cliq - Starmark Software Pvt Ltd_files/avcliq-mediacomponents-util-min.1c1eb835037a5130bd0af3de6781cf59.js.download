var WebRTCPeerConnectionConstants={},ZCWebRTCPeerConnectionUtil={};class RTCConnectionMonitor{constructor(t,e,n,i){this._id=t,this._connection=e,this._candidates=n,this._connectionErrorCB=i,this._selectedCandidateInfo=void 0,this._timeout=void 0}updateCandidates(t){this._candidates.concat(t)}_setCandidatePairInfo(t){this._selectedCandidateInfo=t}_isConnectedViaTCP(){if(this._selectedCandidateInfo)return"relay"===this._selectedCandidateInfo.local_candidate_type&&this._selectedCandidateInfo.local_candidate_port<=WebRTCPeerConnectionConstants.relayUDPPort}start(){this._timeout=setTimeout(()=>{var t=this._connection.iceConnectionState===WebRTCPeerConnectionConstants.iceConnectionStates.CLOSED,e=this._connection.iceConnectionState===WebRTCPeerConnectionConstants.iceConnectionStates.CONNECTED;if(this._candidates&&this._connection&&!t){for(var n=!1,i=!1,a=0;a<this._candidates.length;a++){var o=this._candidates[a];if("relay"===o.type&&(n=!0,i=o.port>WebRTCPeerConnectionConstants.relayUDPPort))return}n&&!i&&WebRTCPeerConnectionStats.getSelectedCandidatePair(this._id,"ConnectionMonitor",this._connection,(t,n,i)=>{this._setCandidatePairInfo(i),e&&this._selectedCandidateInfo&&"relay"!==this._selectedCandidateInfo.local_candidate_type||this._connectionErrorCB(this._id,{code:WebRTCPeerConnectionConstants.connectionErrors.UDP_BLOCKING,isConnectedViaTCP:e&&this._isConnectedViaTCP()})})}},3e3)}stop(){clearTimeout(this._timeout)}}WebRTCPeerConnectionConstants={iceConnectionStates:{CONNECTED:"connected",COMPLETED:"completed",DISCONNECTED:"disconnected",FAILED:"failed",CLOSED:"closed"},connectionTypes:{AUDIO_VIDEO:"audiovideo",AUDIO:"audio",VIDEO:"video",SCREEN:"screen",DATA_CHANNEL:"datachannel"},connectionModes:{UNIFIED:"unified",PLANB:"planB"},connectionErrors:{UDP_BLOCKING:"701"},relayUDPPort:2e4,isUnifiedPlan:function(t){return this.connectionModes.UNIFIED===t},isPlanB:function(t){return this.connectionModes.PLANB===t},isAudioConnection:function(t){return this.connectionTypes.AUDIO===t},isVideoConnection:function(t){return this.connectionTypes.VIDEO===t},isScreenConnection:function(t){return this.connectionTypes.SCREEN===t},isDataChannelConnection:function(t){return this.connectionTypes.DATA_CHANNEL===t},isConnectionActive:function(t){if(void 0===t)return!1;var e=t.iceConnectionState;return e===this.iceConnectionStates.CONNECTED||e===this.iceConnectionStates.COMPLETED},isConnectionClosed:function(t){return void 0!==t&&t.iceConnectionState===this.iceConnectionStates.CLOSED},processTypes:{INIT:"init",REINIT:"reinit",RESTART:"restart",RENEGOTIATE:"renegotiate"},isInit:function(t){return this.processTypes.INIT===t},isRestart:function(t){return this.processTypes.RESTART===t},isReInit:function(t){return this.processTypes.REINIT===t},isRenegotiate:function(t){return this.processTypes.RENEGOTIATE===t}};ZCWebRTCPeerConnectionUtil={replaceStereoValuesInSdp:function(t){t.sdp=t.sdp.replaceAll("useinbandfec=1","useinbandfec=1;stereo=1;sprop-stereo=1;maxaveragebitrate=128000")}};var WebRTCPeerConnection=function(t,e,n,i,a,o,s,r,c,d,h,l){this._id=t,this._hostId=e,this._mediaStreamContainer=a,this._handler=i,this._turnServer=o,this._userName=s,this._credential=r,this._audioRtpSenders=[],this._videoRtpSenders=[],this._screenRtpSenders=[],this._remoteSDP=h,this._localSDP=void 0,this._localIceCandidates=[],this._iceCandidatesGatheringTimer=void 0,this._remoteIceCandidates=l||[],this._isUpStream=d,this._stream=void 0,this._streamType=c,this._connectionType=n,this._processType=WebRTCPeerConnectionConstants.processTypes.INIT,this._isReconnecting=!1,this._reconnectTimer=void 0,this._reconnectInterval=void 0,this._canUpdateLocalIceCandidates=!1,this._initialize(this._processType)};WebRTCPeerConnection.prototype={_addTracksInConnection:function(){void 0!==this._stream&&(WebRTCUserMedia.isScreenStreamType(this._streamType)?this._addScreenTracksInConnection():this._addAVTracksInConnection())},_addAVTracksInConnection:function(){this._addAudioTracksInConnection(),this._addVideoTracksInConnection()},_addAudioTracksInConnection:function(){this._stream.getTracks().forEach(function(t){"audio"===t.kind&&this._audioRtpSenders.push(this._connection.addTrack(t,this._stream))}.bind(this))},_addVideoTracksInConnection:function(){this._stream.getTracks().forEach(function(t){"video"===t.kind&&this._videoRtpSenders.push(this._connection.addTrack(t,this._stream))}.bind(this))},_addScreenTracksInConnection:function(){this._stream.getTracks().forEach(function(t){this._screenRtpSenders.push(this._connection.addTrack(t,this._stream))}.bind(this))},_removeAVTracksInConnection:function(){this._removeAudioTracksInConnection(),this._removeVideoTracksInConnection()},_removeAudioTracksInConnection:function(){this._audioRtpSenders.forEach(function(t){this._connection.removeTrack(t)}.bind(this)),this._audioRtpSenders=[]},_removeVideoTracksInConnection:function(){this._videoRtpSenders.forEach(function(t){this._connection.removeTrack(t)}.bind(this)),this._videoRtpSenders=[]},_initialize:function(t){this._processType=t,WebRTCPeerConnectionConstants.isReInit(t)&&(this._closeConnection(),clearInterval(this._reconnectInterval),this._reconnectInterval=void 0),this._connection||(this._connection=new RTCPeerConnection(this._getConfiguration())),this._bindEventHandlers(t),this._isUpStream?(!WebRTCPeerConnectionConstants.isReInit(t)&&this._stream||(this._stream=WebRTCUserMedia.getStream(this._streamType),this._addTracksInConnection()),this._createOffer(t)):this._createAnswer()},_bindEventHandlers:function(t){var e=!1,n=this._connection,i=function(n){var i=n.candidate;if(i)if(e){if(this._localIceCandidates.push(i.candidate),!this._canUpdateLocalIceCandidates)return;if(!this._iceCandidatesGatheringTimer){var a=function(){this._handler.updateIceCandidates(this._id,this._connectionType,this._hostId,this._localIceCandidates,t),this._localIceCandidates=[],this._iceCandidatesGatheringTimer=void 0}.bind(this);this._iceCandidatesGatheringTimer=setTimeout(a,1e3)}}else this._isUpStream?WebRTCPeerConnectionConstants.isRenegotiate(t)||this._handler.sendOffer(this._id,this._connectionType,this._localSDP.sdp,i.candidate,t,this._streamType):this._handler.sendAnswer(this._id,this._connectionType,this._localSDP.sdp,i.candidate,t,this._hostId),e=!0}.bind(this),a=function(e){var i=n.iceConnectionState;if(WebRTCPeerConnectionConstants.iceConnectionStates.CONNECTED===i||WebRTCPeerConnectionConstants.iceConnectionStates.COMPLETED===i)this._processType=WebRTCPeerConnectionConstants.processTypes.INIT,this._isReconnecting=!1,clearInterval(this._reconnectInterval),this._reconnectInterval=void 0,clearTimeout(this._reconnectTimer),this._reconnectTimer=void 0,this._handler.handleConnected(this._id,this._connectionType,this._connection,this._hostId,this._streamType,this._isUpStream,t);else if(WebRTCPeerConnectionConstants.iceConnectionStates.FAILED===i){this._reconnect();var a=this;clearInterval(this._reconnectInterval),this._reconnectInterval=setInterval((function(){a._reconnect()}),15e3)}}.bind(this),o=function(t){void 0===this._stream&&(this._stream=t.streams[0],this._stream._setType(this._streamType),this._mediaStreamContainer&&(this._mediaStreamContainer.setStream(this._stream),this._mediaStreamContainer.playStream(function(){this._handler.handlePlay(this._connectionType,this._hostId,this._stream,this._streamType,this._mediaStreamContainer)}.bind(this),function(t){"function"==typeof this._handler.handlePlayError&&this._handler.handlePlayError(t)}.bind(this))),"function"==typeof this._handler.handleTrack&&this._handler.handleTrack(this._id,t.track,t.transceiver,t.streams[0],this._hostId))}.bind(this);n.onicecandidate=i,n.oniceconnectionstatechange=a,n.ontrack=o;var s=function(e){var i=n.connectionState;WebRTCPeerConnectionConstants.iceConnectionStates.CONNECTED===i?(this._processType=WebRTCPeerConnectionConstants.processTypes.INIT,this._isReconnecting=!1,clearInterval(this._reconnectInterval),this._reconnectInterval=void 0,clearTimeout(this._reconnectTimer),this._reconnectTimer=void 0,this._handler.handleConnected(this._id,this._connectionType,this._connection,this._hostId,this._streamType,this._isUpStream,t)):WebRTCPeerConnectionConstants.iceConnectionStates.FAILED===i&&(this._reconnect(),clearInterval(this._reconnectInterval),this._reconnectInterval=setInterval(function(){this._reconnect()}.bind(this),15e3))}.bind(this);n.onconnectionstatechange=s},addTrack:function(t,e){this._isUpStream&&(this._stream=t,this._streamType=t._getType(),WebRTCUserMedia.isAudioStreamType(e)?0===this._audioRtpSenders.length&&this._addAudioTracksInConnection():WebRTCUserMedia.isVideoStreamType(e)?0===this._videoRtpSenders.length&&this._addVideoTracksInConnection():WebRTCUserMedia.isScreenStreamType(e)&&0===this._screenRtpSenders.length&&this._addScreenTracksInConnection(),this._renegotiate())},_renegotiate:function(){this._isUpStream&&(this._isReconnecting=!1,clearInterval(this._reconnectInterval),clearTimeout(this._reconnectTimer),this._initialize(WebRTCPeerConnectionConstants.processTypes.RENEGOTIATE))},_reconnect:function(){if(!this._isReconnecting){this._isReconnecting=!0;var t=WebRTCPeerConnectionConstants.processTypes.RESTART;"function"==typeof this._handler.getUpStreamReconnectProcessType&&(t=this._handler.getUpStreamReconnectProcessType()),this._processType=t,clearTimeout(this._reconnectTimer);var e=this;this._reconnectTimer=setTimeout((function(){e._isReconnecting=!1}),1e4),this._isUpStream&&this._initialize(t),this._handler.reconnectStream(this._id,this._connectionType,this._hostId,this._streamType,this._isUpStream)}},reinit:function(){this._initialize(WebRTCPeerConnectionConstants.processTypes.REINIT)},replaceTracks:function(t,e){this._isUpStream&&(this._stream=t,this._streamType=t._getType(),WebRTCUserMedia.isAudioVideoStreamType(e)?this._removeAVTracksInConnection():WebRTCUserMedia.isAudioStreamType(e)?(this._removeAudioTracksInConnection(),this._addAudioTracksInConnection()):(this._removeVideoTracksInConnection(),this._addVideoTracksInConnection()),this.reinit())},_createOffer:function(t){var e={};WebRTCPeerConnectionConstants.isRestart(t)&&(e.iceRestart=!0,this._localIceCandidates=[]);var n=this._connection,i=this;n.createOffer(e).then((function(e){i._replaceOfferValues(e),i._localSDP=e,n.setLocalDescription(e),WebRTCPeerConnectionConstants.isRenegotiate(t)&&i._handler.handleRenegotiate(i._id,i._connectionType,e.sdp,i._streamType)}))},_replaceOfferValues:function(t){WebRTCPeerConnectionConstants.isScreenConnection(this._connectionType)&&this._stream._hasAudioTrack()&&ZCWebRTCPeerConnectionUtil.replaceStereoValuesInSdp(t)},_createAnswer:function(){var t={},e=this._connection,n=this;e.setRemoteDescription(this._getRTCSessionDescriptionObj("offer",this._remoteSDP)).then((function(){e.createAnswer(t).then((function(t){n._localSDP=t,e.setLocalDescription(t)}))}))},setRemoteDescription:function(t,e,n){n&&n.length&&(this._remoteIceCandidates=n);var i=this;this._connection.setRemoteDescription(this._getRTCSessionDescriptionObj(t,e)).then((function(){i.addRemoteIceCandidates()}))},addRemoteIceCandidates:function(){var t=this._connection;this._remoteIceCandidates.forEach((function(e){t.addIceCandidate(new RTCIceCandidate(e))})),this._remoteIceCandidates=[]},updateLocalIceCandidates:function(){this._canUpdateLocalIceCandidates=!0,this._handler.updateIceCandidates(this._id,this._connectionType,this._hostId,this._localIceCandidates,this._processType),this._localIceCandidates=[]},_getRTCSessionDescriptionObj:function(t,e){return new RTCSessionDescription({type:t,sdp:e})},_closeConnection:function(){clearTimeout(this._reconnectTimer),this._reconnectTimer=void 0,clearTimeout(this._iceCandidatesGatheringTimer),this._iceCandidatesGatheringTimer=void 0,this._connection&&(this._connection.close(),this._connection=void 0),this._isReconnecting=!1,this._canUpdateLocalIceCandidates=!1,this._audioRtpSenders=[],this._videoRtpSenders=[],this._screenRtpSenders=[],this._remoteSDP=void 0,this._localSDP=void 0,this._localIceCandidates=[],this._remoteIceCandidates=[]},close:function(t){clearInterval(this._reconnectInterval),this._reconnectInterval=void 0,this._closeConnection(),!t&&this._stream&&this._isUpStream&&WebRTCUserMedia.closeStream(this._stream._getType())},_getConfiguration:function(){var t=this._turnServer,e=this._userName,n=this._credential,i=[];return t.forEach((function(t){i.push({urls:t,username:e,credential:n})})),{iceServers:i}},setBitRate:function(t){this._videoRtpSenders.forEach((function(e){var n=e.getParameters();n.encodings||(n.encodings=[{}]),n.encodings[0].maxBitrate=1e3*t,e.setParameters(n)}))}};var WebRTCPeerConnectionStats={},CallStrengthAnalyser={},CallStrengthStatsConstants={},GroupCallStrengthAnalyser={};WebRTCPeerConnectionStats=function(){var t={},e=void 0,n=1e3,i="standard",a={connectedTransportKeyIncludes:"RTCTransport_",candidateKeyIncludes:"RTCIceCandidate",hostCandidateTypeValue:"host",candidatePairType:"candidate-pair",candidatePairSelectedState:"succeeded",localCandidateType:"local-candidate",remoteCandidateType:"remote-candidate",transportStatType:"transport",ssrcKeyName:"ssrc",ssrcListKeyName:"ssrclist",subTypeKeyName:"subTypeKey"},o={"outbound-rtp":{subTypeKey:"kind",kind:{audio:"RTCOutboundRTPAudioStream_",video:"RTCOutboundRTPVideoStream_"}},"inbound-rtp":{subTypeKey:"kind",kind:{audio:"RTCInboundRTPAudioStream_",video:"RTCInboundRTPVideoStream_"}},"remote-inbound-rtp":{subTypeKey:"kind",kind:{audio:"RTCRemoteInboundRtpAudioStream_",video:"RTCRemoteInboundRtpVideoStream_"}}},s={RTCLiveIceCandidatePair:{bytesSent:"bytessent",bytesReceived:"bytesreceived",availableOutgoingBitrate:"availablebitrate",availableIncomingBitrate:"recvbitrate",totalRoundTripTime:"totalrtt",currentRoundTripTime:"rtt"},RTCOutboundRTPVideoStream_:{pliCount:"videoplisrecv",nackCount:"videonacksrecv",bytesSent:"videobytessent",framesEncoded:"framesencoded",packetsSent:"videopacketssent",framesSent:"videoframessent",totalEncodeTime:"totalencodetime",totalPacketSendDelay:"totalpacketsenddelay"},RTCRemoteInboundRtpVideoStream_:{jitter:"sendvideojitter",packetsLost:"sendvideopacketlost"},RTCInboundRTPAudioStream_:{jitter:"recvaudiojitter",packetsLost:"recvaudiopacketlost",packetsReceived:"audiopacketsreceived"},RTCInboundRTPVideoStream_:{pliCount:"videoplissent",nackCount:"videonackssent",packetsLost:"recvvideopacketlost",bytesReceived:"bytesreceived",packetsReceived:"packetsreceived",framesDecoded:"framesdecoded",totalDecodeTime:"totaldecodetime",totalInterFrameDelay:"totalinterframedelay",framesReceived:"framesreceived",framesDropped:"framesdropped"},RTCOutboundRTPAudioStream_:{packetsSent:"audiopacketssent",bytesSent:"audiobytessent"},RTCRemoteInboundRtpAudioStream_:{jitter:"sendaudiojitter",packetsLost:"sendaudiopacketlost"}},r=["RTCOutboundRTPVideoStream_","RTCRemoteInboundRtpAudioStream_","RTCRemoteInboundRtpVideoStream_","RTCInboundRTPAudioStream_","RTCInboundRTPVideoStream_","RTCOutboundRTPAudioStream_"],c=function(t,e,n,i,a){this._moduleId=e,this._id=t,this._connection=n,this._connectionMetaData=i,this._timeVsStats={},this._networkInfo={},this._candidatePairInfo={},this._networkInfoCallBack=a.networkInfoCallBack,this._updateStatsCallBack=a.updateStatsCallBack,this._statsCallBack=a.statsCallBack,this._candidatePairInfoCallBack=a.candidatePairInfoCallBack,this._hasSentNetworkInfo=!1,this._hasSentCandidatePairInfo=!1,this._statsObjectMaxSize=30,void 0!==i&&void 0!==i.statsObjectMaxSize&&(this._statsObjectMaxSize=i.statsObjectMaxSize)};function d(){return"undefined"!=typeof $ZCUtil&&"undefined"!=typeof RTCStatsReport}function h(t){return(function(t){return void 0!==t&&t.type===a.localCandidateType}(t)||function(t){return void 0!==t&&t.type===a.remoteCandidateType}(t))&&t.candidateType===a.hostCandidateTypeValue}function l(t){return function(t){return void 0!==t&&t.type===a.candidatePairType&&(void 0===t.nominated||t.nominated)}(t)&&t.state===a.candidatePairSelectedState}function u(t){return void 0!==t&&t.type===a.transportStatType}function S(t){var e=void 0,n=t.values(),i=void 0;do{var a=(i=n.next()).value;if(l(a)){e=a.id;break}if(u(a)){e=a.selectedCandidatePairId;break}}while(!i.done);return e}function _(t,e,n){var i={},c=function(t,e){for(var n in s)if(-1!==t.indexOf(n)||t.toUpperCase()===n.toUpperCase())return n;for(var i in o)if(e.type===i){var r=o[i],c=r[a.subTypeKeyName];return void 0!==c?r[c][e[c]]:r}}(t,e);if(c){var d=n&&function(t){return-1!==r.indexOf(t)}(c),h=s[c];for(var l in h)if(d){var u=e[a.ssrcKeyName];void 0===i[u]&&(i[a.ssrcKeyName]=u,i[u]={}),i[u][h[l]]=e[l]}else i[h[l]]=e[l]}return i}function m(t,e,n){var i=e.get(n.localCandidateId),a=e.get(n.remoteCandidateId),o=i.networkType,s=i.ip||i.address,r=void 0,c=(a.ip||a.address,void 0);void 0!==(c=h(i)?i:function(t,e){var n;return t.forEach((function(t,i){h(t)&&t.networkType===e&&(n=t)})),n}(e,o))&&(r=c.ip||c.address),t.setNetworkInfo(o,r,s,i,a),t.sendNetworkInfo()}function p(t,e,n){var i=e.get(n.localCandidateId),a=e.get(n.remoteCandidateId);t.setCandidatePairInfo(i,a),t.sendCandidatePairInfo()}function C(t){var e=t.getConnection();WebRTCPeerConnectionConstants.isConnectionClosed(e)?v(t.getId(),t.getModuleId()):WebRTCPeerConnectionConstants.isConnectionActive(e)&&e.getStats().then((function(e){var n=S(e);if(void 0!==n){var i=e.get(n);t.hasSentNetworkInfo()||m(t,e,i),t.hasSentCandidatePairInfo()||p(t,e,i);var o=t.isSSRCBased(),s=new Set,r=_("RTCLiveIceCandidatePair",i,o);e.forEach((function(t,e){var n=_(e,t,o);o&&n[a.ssrcKeyName]&&(s.add(n[a.ssrcKeyName]),delete n[a.ssrcKeyName]),ZCJQuery.extend(!0,r,n)})),o&&(r[a.ssrcListKeyName]=[...s]);var c="undefined"!=typeof $ZCUtil?$ZCUtil.getSyncedCurrentTime():Date.now();t.updateAndSendStats(c,r,e)}}))}function v(n,i){var a=t[i];if(void 0!==a){var o=a[n];o&&o._sendStats(),delete a[n],0===Object.keys(a).length&&delete t[i]}0===Object.keys(t).length&&(clearInterval(e),e=void 0)}return c.prototype={setNetworkInfo:function(t,e,n,i,a){var o=i.ip||i.address;void 0!==i.port&&(o=o+":"+i.port);var s=a.ip||a.address;void 0!==a.port&&(s=s+":"+a.port),this._networkInfo={network_type:t,private_ip:e,public_ip:n,local_ip:o,remote_ip:s,local_candidate_type:i.candidateType}},setCandidatePairInfo:function(t,e){this._candidatePairInfo={remote_ip:e.ip||e.address,local_ip:t.ip||t.address,remote_candidate_type:e.candidateType,local_candidate_type:t.candidateType,remote_candidate_port:e.port,local_candidate_port:t.port}},getId:function(){return this._id},getModuleId:function(){return this._moduleId},getConnection:function(){return this._connection},isSSRCBased:function(){return void 0!==this._connectionMetaData&&this._connectionMetaData.isSSRCBased},hasSentNetworkInfo:function(){return this._hasSentNetworkInfo},sendNetworkInfo:function(){"function"==typeof this._networkInfoCallBack&&this._networkInfoCallBack(this._id,this._moduleId,this._networkInfo,i,this._connectionMetaData),this._hasSentNetworkInfo=!0},hasSentCandidatePairInfo:function(){return this._hasSentCandidatePairInfo},sendCandidatePairInfo:function(){"function"==typeof this._candidatePairInfoCallBack&&this._candidatePairInfoCallBack(this._id,this._moduleId,this._candidatePairInfo),this._hasSentCandidatePairInfo=!0},updateAndSendStats:function(t,e,n){this._timeVsStats[t]=e,"function"==typeof this._statsCallBack&&this._statsCallBack(t,e,n,this._connectionMetaData),Object.keys(this._timeVsStats).length===this._statsObjectMaxSize&&this._sendStats()},_sendStats:function(){"function"==typeof this._updateStatsCallBack&&this._updateStatsCallBack(this._id,this._moduleId,this._timeVsStats,i,this._connectionMetaData),this._timeVsStats={}}},{isStatsSupported:d,initiateGathering:function(i,a,o,s,r){if(void 0!==i&&void 0!==a&&void 0!==o&&(void 0!==r.statsCallBack||void 0!==r.networkInfoCallBack&&void 0!==r.updateStatsCallBack)){if(!d())return o.getStats().then(function(t){var e=S(t);p(new c(i,a,o,s,r),t,t.get(e))}.bind(this)),void function(t,e,n){"function"==typeof n.errorCallback&&n.errorCallback(t,e)}(i,a,r);var h=t[a]||{};h[i]=new c(i,a,o,s,r),t[a]=h,void 0===e&&(e=setInterval((function(){!function(){for(var e in t){var n=t[e];for(var i in n){var a=n[i];try{C(a)}catch(t){}}}}()}),n))}},stopGathering:v,getSelectedCandidatePair:function(t,e,n,i){t&&e&&n&&"function"==typeof i&&n.getStats().then(function(a){var o=S(a);p(new c(t,e,n,void 0,{candidatePairInfoCallBack:i}),a,a.get(o))}.bind(this))}}}(),CallStrengthStatsConstants={maxThresholdScore:10,callStrengthCalcInterval:1e4,statsGatheringInterval:1e3,audioDownStreamScore:{paramsCount:2,lostParamsCount:1},audioUpStreamScore:{paramsCount:2,lostParamsCount:0},videoDownStreamScore:{paramsCount:3,lostParamsCount:1},videoUpStreamScore:{paramsCount:3,lostParamsCount:0},rtt:{maxThreshold:.8,minThreshold:.3},jitter:{audioMinThreshold:.03,videoMinThreshold:.2},packetSent:{maxThreshold:40,minThreshold:30},bytesSent:{maxThreshold:2500,minThreshold:1500},frames:{maxDecodeValue:7,delayThreshold:.15},video:{maxEncodingDelay:.15,maxPacketSentDelay:.05},iceCandidatePair:"RTCIceCandidatePair",mediaTrackReceiver:"RTCMediaStreamTrack_receiver",mediaTrackSender:"sender",rtpType:{outBound:"outbound-rtp",inBound:"inbound-rtp"},statType:{audio:"audio",video:"video"}},(CallStrengthAnalyser=function(t,e,n){this._id=t,this._peerConnection=e,this._statType=void 0,this._statsGatheringTimer=void 0,this._updateScoreTimer=void 0,this._callBacks=n,this._prevAudioBytesSent=0,this._prevAudioPacketsSent=0,this._prevAudioPacketsReceived=0,this._prevAudioPacketsLost=0,this._currentAudioPacketsReceived=0,this._currentAudioPacketsLost=0,this._prevVideoFramesDecoded=0,this._prevVideoInterFrameDelay=0,this._prevVideoPacketSendDelay=0,this._prevVideoDecodeTime=0,this._prevVideoEncodeTime=0,this._prevVideoPacketsSent=0,this._prevVideoPacketsLost=0,this._prevVideoPacketsReceived=0,this._prevVideoFramesSent=0,this._prevVideoFramesLost=0,this._prevVideoFramesReceived=0,this._prevVideoFramesEncoded=0,this._prevVideoJitterBufferDelay=0,this._prevVideoJitterBufferEmittedCount=0,this._currentVideoPacketsLost=0,this._currentVideoPacketsReceived=0,this._currentVideoFramesLost=0,this._currentVideoFramesReceived=0,this._lastAudioPacketReceivedTimestamp=0,this._lastVideoPacketReceivedTimestamp=0,this._rttArray=[],this._audioJitterBufferArray=[],this._audioPacketsSentArray=[],this._audioBytesSentArray=[],this._framesDecodedArray=[],this._videoJitterBufferArray=[],this._interFrameDelayArray=[],this._decodeTimeArray=[],this._framesSentArray=[],this._videoFramesEncodingTimeArray=[],this._videoPacketSendDelayTimeArray=[],this._callStrengthScore=void 0,this._lastUpdatedTime=(new Date).getTime(),this._initiate()}).prototype={getId:function(){return this._id},getConnection:function(){return this._peerConnection},_setStatType:function(t){this._statType=t},_getCurrentStatType:function(){return this._statType},_hasVideoStat:function(){return this._getCurrentStatType()===CallStrengthStatsConstants.statType.video},_setScore:function(t){this._callStrengthScore=t},getScore:function(){return this._callStrengthScore},_initiate:function(){if(void 0!==this._id&&void 0!==this._peerConnection&&void 0!==this._callBacks&&void 0!==this._callBacks.updateCallQuality)return"undefined"==typeof $ZCUtil||!$ZCUtil.Browser.isChrome()&&!$ZCUtil.Browser.isOpera()?"function"==typeof this._callBacks.handleFallback?this._callBacks.handleFallback():void 0:void this._startAnalysis()},_startAnalysis:function(){clearInterval(this._statsGatheringTimer),this._statsGatheringTimer=setInterval(this._initiateStatsGathering.bind(this),CallStrengthStatsConstants.statsGatheringInterval),this._updateScoreTimer=setInterval(this._updateScore.bind(this),CallStrengthStatsConstants.callStrengthCalcInterval)},stopAnalysis:function(){clearInterval(this._statsGatheringTimer),clearInterval(this._updateScoreTimer)},_initiateStatsGathering:function(){this._peerConnection.getStats().then(function(t){this._gatherStats(t)}.bind(this))},_gatherStats:function(t){t.forEach(function(t){t.id.includes(CallStrengthStatsConstants.iceCandidatePair)&&t.nominated&&this._rttArray.push(t.currentRoundTripTime),t.kind===CallStrengthStatsConstants.statType.audio?this._gatherAudioStat(t):t.kind===CallStrengthStatsConstants.statType.video&&this._gatherVideoStat(t),void 0!==t.kind&&this._setStatType(t.kind)}.bind(this))},_gatherAudioStat:function(t){t.type===CallStrengthStatsConstants.rtpType.outBound&&void 0!==t.mediaSourceId&&(this._audioPacketsSentArray.push(t.packetsSent-this._prevAudioPacketsSent),this._audioBytesSentArray.push(t.bytesSent-this._prevAudioBytesSent),this._prevAudioPacketsSent=t.packetsSent,this._prevAudioBytesSent=t.bytesSent),t.type===CallStrengthStatsConstants.rtpType.inBound&&t.lastPacketReceivedTimestamp-this._lastAudioPacketReceivedTimestamp>0&&(this._audioJitterBufferArray.push(t.jitter),this._currentAudioPacketsLost=t.packetsLost,this._currentAudioPacketsReceived=t.packetsReceived,this._lastAudioPacketReceivedTimestamp=t.lastPacketReceivedTimestamp)},_gatherVideoStat:function(t){if(t.id.includes(CallStrengthStatsConstants.mediaTrackSender)&&(this._framesSentArray.push(t.framesSent-this._prevVideoFramesSent),this._prevVideoFramesSent=t.framesSent),t.id.includes(CallStrengthStatsConstants.mediaTrackReceiver)){this._currentVideoFramesReceived=t.framesReceived,this._currentVideoFramesLost=t.framesDropped;var e=t.jitterBufferDelay,n=t.jitterBufferEmittedCount;0!=this._prevVideoJitterBufferEmittedCount&&(e-=this._prevVideoJitterBufferDelay,n-=this._prevVideoJitterBufferEmittedCount),this._videoJitterBufferArray.push(e/n),this._prevVideoJitterBufferDelay=t.jitterBufferDelay,this._prevVideoJitterBufferEmittedCount=t.jitterBufferEmittedCount}if(t.type===CallStrengthStatsConstants.rtpType.outBound&&void 0!==t.mediaSourceId&&(this._videoFramesEncodingTimeArray.push((t.totalEncodeTime-this._prevVideoEncodeTime)/(t.framesEncoded-this._prevVideoFramesEncoded)),this._videoPacketSendDelayTimeArray.push((t.totalPacketSendDelay-this._prevVideoPacketSendDelay)/(t.packetsSent-this._prevVideoPacketsSent)),this._prevVideoFramesEncoded=t.framesEncoded,this._prevVideoEncodeTime=t.totalEncodeTime,this._prevVideoPacketSendDelay=t.totalPacketSendDelay,this._prevVideoPacketsSent=t.packetsSent),t.type===CallStrengthStatsConstants.rtpType.inBound&&t.lastPacketReceivedTimestamp-this._lastVideoPacketReceivedTimestamp>0){this._currentVideoPacketsLost=t.packetsLost,this._currentVideoPacketsReceived=t.packetsReceived;var i=t.framesDecoded-this._prevVideoFramesDecoded;this._framesDecodedArray.push(i),this._interFrameDelayArray.push((t.totalInterFrameDelay-this._prevVideoInterFrameDelay)/i),this._decodeTimeArray.push((t.totalDecodeTime-this._prevVideoDecodeTime)/i),this._prevVideoFramesDecoded=t.framesDecoded,this._prevVideoDecodeTime=t.totalDecodeTime,this._prevVideoInterFrameDelay=t.totalInterFrameDelay,this._lastVideoPacketReceivedTimestamp=t.lastPacketReceivedTimestamp}},_resetStats:function(){this._rttArray=[],this._audioJitterBufferArray=[],this._audioPacketsSentArray=[],this._audioBytesSentArray=[],this._framesDecodedArray=[],this._videoJitterBufferArray=[],this._interFrameDelayArray=[],this._decodeTimeArray=[],this._framesSentArray=[],this._videoFramesEncodingTimeArray=[],this._videoPacketSendDelayTimeArray=[]},getCurrentStats:function(){CallStrengthStatsConstants.maxThresholdScore=Math.round(((new Date).getTime()-this._lastUpdatedTime)/1e3);var t=this._analyseDownStreamConnectionStrength(),e=this._analyseUpStreamConnectionStrength();return CallStrengthStatsConstants.maxThresholdScore=10,{downstreamStrength:t,upstreamStrength:e}},_updateScore:function(){this._lastUpdatedTime=(new Date).getTime();var t=this._analyseDownStreamConnectionStrength(),e=this._analyseUpStreamConnectionStrength(),n=CallStrengthStatsConstants.maxThresholdScore,i=n/2,a=n*CallStrengthStatsConstants.audioDownStreamScore.paramsCount+i*CallStrengthStatsConstants.audioDownStreamScore.lostParamsCount,o=n*CallStrengthStatsConstants.audioUpStreamScore.paramsCount+i*CallStrengthStatsConstants.audioUpStreamScore.lostParamsCount,s=Math.round((a-t.audioJitterScore-t.rttScore-t.audioPacketsLostPercentage)/(a/5)),r=Math.round((o-e.audioPacketsSentScore-e.audioBytesSentScore)/(o/5));(t.audioJitterScore>=.6*n||t.rttScore>=.6*n||t.audioPacketsLostPercentage>=.4*i)&&s>3&&(s=3);var c={upStreamScore:{audioUpStreamPerformanceScore:r},performanceScore:{audioPerformanceScore:s}};if(this._hasVideoStat()){var d=n*CallStrengthStatsConstants.videoDownStreamScore.paramsCount+i*CallStrengthStatsConstants.videoDownStreamScore.lostParamsCount,h=n*CallStrengthStatsConstants.videoUpStreamScore.paramsCount+i*CallStrengthStatsConstants.videoUpStreamScore.lostParamsCount,l=Math.round((d-t.videoJitterScore-t.frameScore-t.interFrameDelayScore-t.videoFramesLostPercentage)/(d/5)),u=Math.round((h-e.frameSentScore-e.videoEncodingScore-e.videoPacketSendDelayScore)/(h/5));(t.videoJitterScore>=.6*n||t.frameScore>=.6*n||t.interFrameDelayScore>=.6*n||t.videoFramesLostPercentage>=.4*i)&&l>3&&(l=3),c.upStreamScore.videoUpStreamPerformanceScore=u,c.performanceScore.videoPerformanceScore=l}var S={downstreamStrength:t,upstreamStrength:e};this._setScore(c),this._callBacks.updateCallQuality(this.getId(),c,S),this._resetStats()},_analyseDownStreamConnectionStrength:function(){var t=this._currentAudioPacketsReceived-this._prevAudioPacketsReceived,e=this._currentAudioPacketsLost-this._prevAudioPacketsLost,n={audioPacketsLostPercentage:this._calculateLossPercentage(t,e),audioJitterScore:this._calculateJitterScore(this._audioJitterBufferArray,CallStrengthStatsConstants.jitter.audioMinThreshold),rttScore:this._calculateRTTScore()};if(this._prevAudioPacketsReceived=this._currentAudioPacketsReceived,this._prevAudioPacketsLost=this._currentAudioPacketsLost,this._hasVideoStat()){var i=this._currentVideoPacketsReceived-this._prevVideoPacketsReceived,a=this._currentVideoPacketsLost-this._prevVideoPacketsLost,o=this._currentVideoFramesReceived-this._prevVideoFramesReceived,s=this._currentVideoFramesLost-this._prevVideoFramesLost;n.videoPacketsLostPercentage=this._calculateLossPercentage(i,a),n.videoFramesLostPercentage=this._calculateLossPercentage(o,s),n.videoJitterScore=this._calculateJitterScore(this._videoJitterBufferArray,CallStrengthStatsConstants.jitter.videoMinThreshold),n.frameScore=this._calculateFrameScore(this._framesDecodedArray),n.interFrameDelayScore=this._calculateFrameDelayScore(),this._prevVideoPacketsReceived=this._currentVideoPacketsReceived,this._prevVideoPacketsLost=this._currentVideoPacketsLost,this._prevVideoFramesReceived=this._currentVideoFramesReceived,this._prevVideoFramesLost=this._currentVideoFramesLost}return n},_analyseUpStreamConnectionStrength:function(){var t={audioPacketsSentScore:this._calculateAudioUpStreamScore(this._audioPacketsSentArray,CallStrengthStatsConstants.packetSent.minThreshold,CallStrengthStatsConstants.packetSent.maxThreshold),audioBytesSentScore:this._calculateAudioUpStreamScore(this._audioBytesSentArray,CallStrengthStatsConstants.bytesSent.minThreshold,CallStrengthStatsConstants.bytesSent.maxThreshold)};if(this._hasVideoStat()){var e=this._calculateFrameScore(this._framesSentArray);t.videoEncodingScore=this._calculateVideoUpStreamDelayScore(this._videoFramesEncodingTimeArray,CallStrengthStatsConstants.video.maxEncodingDelay),t.videoPacketSendDelayScore=this._calculateVideoUpStreamDelayScore(this._videoPacketSendDelayTimeArray,CallStrengthStatsConstants.video.maxPacketSentDelay),t.frameSentScore=e>CallStrengthStatsConstants.maxThresholdScore?CallStrengthStatsConstants.maxThresholdScore:e}return t},_calculateRTTScore:function(){var t=0,e=this._rttArray.length;for(var n of(e<CallStrengthStatsConstants.maxThresholdScore&&(t=CallStrengthStatsConstants.maxThresholdScore-e),this._rttArray))null==n||n>CallStrengthStatsConstants.rtt.maxThreshold?t+=2:n>CallStrengthStatsConstants.rtt.minThreshold&&t++;return t>CallStrengthStatsConstants.maxThresholdScore?CallStrengthStatsConstants.maxThresholdScore:t},_calculateJitterScore:function(t,e){var n=0,i=t.length;for(var a of(i<CallStrengthStatsConstants.maxThresholdScore&&(n=CallStrengthStatsConstants.maxThresholdScore-i),t))(null==a||isNaN(a)||a>e)&&n++;return n},_calculateFrameScore:function(t){var e=0,n=t.length;for(var i of(n<CallStrengthStatsConstants.maxThresholdScore&&(e=CallStrengthStatsConstants.maxThresholdScore-n),t))(null==i||i<CallStrengthStatsConstants.frames.maxDecodeValue)&&e++;return e},_calculateFrameDelayScore:function(){var t=0,e=this._interFrameDelayArray.length;for(var n of(e<CallStrengthStatsConstants.maxThresholdScore&&(t=CallStrengthStatsConstants.maxThresholdScore-e),this._interFrameDelayArray))(null==n||isNaN(n)||n>CallStrengthStatsConstants.frames.delayThreshold)&&t++;return t},_calculateLossPercentage:function(t,e){var n=CallStrengthStatsConstants.maxThresholdScore/2;return null==e||null==t||0==t||isNaN(e)||isNaN(t)||(n=Math.round(e/t*CallStrengthStatsConstants.maxThresholdScore/2))>CallStrengthStatsConstants.maxThresholdScore/2&&(n=CallStrengthStatsConstants.maxThresholdScore/2),n},_calculateAudioUpStreamScore:function(t,e,n){var i=0,a=t.length;for(var o of(a<CallStrengthStatsConstants.maxThresholdScore&&(i=CallStrengthStatsConstants.maxThresholdScore-a),t))null==o||o<e?i+=2:o<n&&i++;return i>CallStrengthStatsConstants.maxThresholdScore?CallStrengthStatsConstants.maxThresholdScore:i},_calculateVideoUpStreamDelayScore:function(t,e){var n=0,i=t.length;for(var a of(i<CallStrengthStatsConstants.maxThresholdScore&&(n=CallStrengthStatsConstants.maxThresholdScore-i),t))(null==a||a>e||isNaN(a))&&n++;return n>CallStrengthStatsConstants.maxThresholdScore?CallStrengthStatsConstants.maxThresholdScore:n}},(GroupCallStrengthAnalyser=function(t,e,n,i){this._id=t,this._stageIncreaseCallBack=e,this._stageReduceCallBack=n,this._networkStrengthCallBack=i,this._prevAudioUpStreamSSRCMap={},this._audioUpStreamSSRCMap={},this._audioUpStreamConnectionCrttArray=[],this._audioUpStreamPeformanceMap={},this._prevAudioDownStreamSSRCMap={},this._audioDownStreamSSRCMap={},this._audioDownStreamConnectionCrttArray=[],this._audioDownStreamPeformanceMap={},this._prevVideoFramesEncoded=0,this._prevVideoEncodeTime=0,this._prevVideoPacketSendDelay=0,this._prevVideoPacketsSent=0,this._prevVideoFramesSent=0,this._videoFramesSentArray=[],this._videoFramesEncodingTimeArray=[],this._videoPacketSendDelayTimeArray=[],this._videoDownStreamSSRCMap={},this._audioUpStreamConnectionScore=0,this._audioDownStreamConnectionScore=0,this._videoUpStreamConnectionScore=0,this._videoDownStreamConnectionScore=0,this._isAudioUpStreamAnalysed=!1,this._isAudioDownStreamAnalysed=!1,this._isVideoUpStreamAnalysed=!1,this._isVideoDownStreamAnalysed=!1,this._audioUpStreamConnectionStatsData=void 0,this._audioDownStreamConnectionStatsData=void 0,this._videoUpStreamConnectionStatsData=void 0,this._videoDownStreamConnectionStatsData=void 0,this._audioUpStreamConnectionFilteredStatsData=void 0,this._audioDownStreamConnectionFilteredStatsData=void 0,this._videoUpStreamConnectionFilteredStatsData=void 0,this._videoDownStreamConnectionFilteredStatsData=void 0,this._stageCalcInterval=void 0,this._scoreUpdateInterval=void 0,this.initiate()}).prototype={initiate:function(){clearInterval(this._scoreUpdateInterval),this._scoreUpdateInterval=setInterval(function(){this._calculateAudioUpStreamConnectionScore(),this._calculateAudioDownStreamConnectionScore(),this._calculateVideoUpStreamConnectionScore()}.bind(this),9e3),clearInterval(this._stageCalcInterval),this._stageCalcInterval=setInterval(function(){var t=!1,e=!1,n=0,i=0,a=void 0,o=void 0;this._isAudioDownStreamAnalysed&&(a=this._audioDownStreamConnectionScore,n+=this._audioDownStreamConnectionScore,i++,this._audioDownStreamConnectionScore<=2?t=!0:this._audioDownStreamConnectionScore>=4&&(e=!0),this._isAudioDownStreamAnalysed=!1),this._isAudioUpStreamAnalysed&&(o=this._audioUpStreamConnectionScore,n+=this._audioUpStreamConnectionScore,i++,this._audioUpStreamConnectionScore<=2?(t=!0,e=!1):this._audioUpStreamConnectionScore>=4&&!t&&(e=!0),this._isAudioUpStreamAnalysed=!1),i>0&&(n=Math.round(n/i),this._networkStrengthCallBack(n)),e?this._stageIncreaseCallBack(o,a):t&&this._stageReduceCallBack(o,a)}.bind(this),1e3)},destroy:function(){clearInterval(this._scoreUpdateInterval),this._scoreUpdateInterval=void 0,clearInterval(this._stageCalcInterval),this._stageCalcInterval=void 0},updateAudioUpStreamConnectionStatsData:function(t,e){this._audioUpStreamConnectionStatsData=t,this._audioUpStreamConnectionFilteredStatsData=e,this._setAudioUpStreamConnectionStatsData()},updateAudioDownStreamConnectionStatsData:function(t,e){this._audioDownStreamConnectionStatsData=t,this._audioDownStreamConnectionFilteredStatsData=e,this._setAudioDownStreamConnectionStatsData()},updateVideoUpStreamConnectionStatsData:function(t,e){this._videoUpStreamConnectionStatsData=t,this._videoUpStreamConnectionFilteredStatsData=e,this._setVideoUpStreamConnectionStatsData()},updateVideoDownStreamConnectionStatsData:function(t,e){this._videoDownStreamConnectionStatsData=t,this._videoDownStreamConnectionFilteredStatsData=e,this._setVideoDownStreamConnectionStatsData()},_setAudioUpStreamConnectionStatsData:function(){var t=this._audioUpStreamConnectionStatsData,e=this._audioUpStreamConnectionFilteredStatsData;if(t&&e){void 0!==e.rtt&&this._audioUpStreamConnectionCrttArray.push(e.rtt);var n=e.ssrclist;for(var i of n){var a=e[i],o=this._audioUpStreamSSRCMap[i];o?(o.jitter.push(a.sendaudiojitter),o.packetsLost=a.sendaudiopacketlost,o.packetsSent=a.audiopacketssent):this._audioUpStreamSSRCMap[i]={jitter:[a.sendaudiojitter],packetsLost:a.sendaudiopacketlost,packetsSent:a.audiopacketssent}}}},_calculateAudioUpStreamConnectionScore:function(){if(this._audioUpStreamConnectionStatsData&&this._audioUpStreamConnectionFilteredStatsData){this._audioUpStreamPeformanceMap={};var t=!1,e=0;if(this._audioUpStreamConnectionCrttArray.length){for(var n of(t=!0,this._audioUpStreamConnectionCrttArray))null==n||n>1?e+=2:n>.3&&e++;e>CallStrengthStatsConstants.maxThresholdScore&&(e=CallStrengthStatsConstants.maxThresholdScore)}var i=0,a=0,o=0,s=0;for(var r in this._audioUpStreamSSRCMap){var c=this._audioUpStreamSSRCMap[r],d=0,h=c.packetsLost,l=c.packetsSent;if(this._prevAudioUpStreamSSRCMap&&this._prevAudioUpStreamSSRCMap[r]){var u=this._prevAudioUpStreamSSRCMap[r];u&&(h-=u.packetsLost,l-=u.packetsSent,h<0&&(h=c.packetsLost||0),l<0&&(l=c.packetsSent))}var S=c.jitter,_=0;if(l>0||h>0)for(var m of S)i++,(null==m||m>.03)&&(_++,a++);_>CallStrengthStatsConstants.maxThresholdScore&&(_=CallStrengthStatsConstants.maxThresholdScore),s+=h,o+=l,d=h>0&&l>0?Math.round(h/l*5):0,(isNaN(d)||d>5||d<0)&&(d=5);var p=0;p=t?Math.round((25-_-d-e)/5):Math.round((15-_-d)/3),_>=6&&p>3&&(p=3),this._audioUpStreamPeformanceMap[r]=p}var C=0;(s>0||o>0)&&(C=Math.round(a/i*CallStrengthStatsConstants.maxThresholdScore));var v=0;s>0&&o>0&&(v=Math.round(s/o*5)),v>CallStrengthStatsConstants.maxThresholdScore&&(v=CallStrengthStatsConstants.maxThresholdScore);var f=C+v,T=0;(T=t?Math.round((25-(f+e))/5):Math.round((15-f)/3))>2&&(C>5||v>2||t&&e>5)&&(T=2),this._audioUpStreamConnectionScore=T,this._prevAudioUpStreamSSRCMap=ZCJQuery.extend(!0,{},this._audioUpStreamSSRCMap),this._audioUpStreamConnectionCrttArray=[],this._isAudioUpStreamAnalysed=!0}},_setAudioDownStreamConnectionStatsData:function(){var t=this._audioDownStreamConnectionStatsData,e=this._audioDownStreamConnectionFilteredStatsData;if(t&&e){void 0!==e.rtt&&this._audioDownStreamConnectionCrttArray.push(e.rtt);var n=e.ssrclist;for(var i of n){var a=e[i],o=this._audioDownStreamSSRCMap[i];o?(o.jitter.push(a.recvaudiojitter),o.packetsLost=a.recvaudiopacketlost,o.packetsReceived=a.audiopacketsreceived):this._audioDownStreamSSRCMap[i]={jitter:[a.recvaudiojitter],packetsLost:a.recvaudiopacketlost,packetsReceived:a.audiopacketsreceived}}}},_calculateAudioDownStreamConnectionScore:function(){if(this._audioDownStreamConnectionStatsData&&this._audioDownStreamConnectionFilteredStatsData){this._audioDownStreamPeformanceMap={};var t=!1,e=0;if(this._audioDownStreamConnectionCrttArray.length){for(var n of(t=!0,this._audioDownStreamConnectionCrttArray))null==n||n>1?e+=2:n>.3&&e++;e>CallStrengthStatsConstants.maxThresholdScore&&(e=CallStrengthStatsConstants.maxThresholdScore)}var i=0,a=0,o=0,s=0;for(var r in this._audioDownStreamSSRCMap){var c=this._audioDownStreamSSRCMap[r],d=0,h=c.packetsLost,l=c.packetsReceived;if(this._prevAudioDownStreamSSRCMap&&this._prevAudioDownStreamSSRCMap[r]){var u=this._prevAudioDownStreamSSRCMap[r];u&&(h-=u.packetsLost,l-=u.packetsReceived,h<0&&(h=c.packetsLost||0),l<0&&(l=c.packetsReceived))}var S=c.jitter,_=0;if(l>0||h>0)for(var m of S)i++,(null==m||m>.03)&&(_++,a++);_>CallStrengthStatsConstants.maxThresholdScore&&(_=CallStrengthStatsConstants.maxThresholdScore),s+=h,o+=l,d=h>0&&l>0?Math.round(h/l*5):0,(isNaN(d)||d>5||d<0)&&(d=5);var p=0;p=t?Math.round((25-_-d-e)/5):Math.round((15-_-d)/3),_>=6&&p>3&&(p=3),this._audioDownStreamPeformanceMap[r]=p}var C=0;(s>0||o>0)&&(C=Math.round(a/i*CallStrengthStatsConstants.maxThresholdScore));var v=0;s>0&&o>0&&(v=Math.round(s/o*5)),v>CallStrengthStatsConstants.maxThresholdScore&&(v=CallStrengthStatsConstants.maxThresholdScore);var f=C+v,T=0;(T=t?Math.round((25-(f+e))/5):Math.round((15-f)/3))>2&&(C>5||v>2||t&&e>5)&&(T=2),this._audioDownStreamConnectionScore=T,this._prevAudioDownStreamSSRCMap=ZCJQuery.extend(!0,{},this._audioDownStreamSSRCMap),this._audioDownStreamConnectionCrttArray=[],this._isAudioDownStreamAnalysed=!0}},_setVideoUpStreamConnectionStatsData:function(){var t=this._videoUpStreamConnectionStatsData,e=this._videoUpStreamConnectionFilteredStatsData;if(t&&e){var n=e[e.ssrclist[0]],i=n.totalencodetime-this._prevVideoEncodeTime,a=n.framesencoded-this._prevVideoFramesEncoded;this._videoFramesEncodingTimeArray.push(i/a);var o=n.totalpacketsenddelay-this._prevVideoPacketSendDelay,s=n.packetssent-this._prevVideoPacketsSent;this._videoPacketSendDelayTimeArray.push(o/s),this._videoFramesSentArray.push(n.framessent-this._prevVideoFramesSent),this._prevVideoFramesEncoded=n.framesencoded,this._prevVideoEncodeTime=n.totalencodetime,this._prevVideoPacketSendDelay=n.totalpacketsenddelay,this._prevVideoPacketsSent=n.videopacketssent,this._prevVideoFramesSent=n.videoframessent}},_calculateVideoUpStreamConnectionScore:function(){if(this._videoUpStreamConnectionStatsData&&this._videoUpStreamConnectionFilteredStatsData){var t=0;for(var e of this._videoFramesSentArray)(null==e||e<5)&&t++;var n=Math.round(t/this._videoFramesSentArray.length)*CallStrengthStatsConstants.maxThresholdScore;n>CallStrengthStatsConstants.maxThresholdScore&&(n=CallStrengthStatsConstants.maxThresholdScore);var i=0;for(var a of this._videoFramesEncodingTimeArray)(null==a||isNaN(a)||a>.15)&&i++;var o=Math.round(i/this._videoFramesEncodingTimeArray.length)*CallStrengthStatsConstants.maxThresholdScore;o>CallStrengthStatsConstants.maxThresholdScore&&(o=CallStrengthStatsConstants.maxThresholdScore);var s=0;for(var r of this._videoPacketSendDelayTimeArray)(null==r||isNaN(r)||r>.1)&&s++;var c=Math.round(s/this._videoPacketSendDelayTimeArray.length)*CallStrengthStatsConstants.maxThresholdScore;c>CallStrengthStatsConstants.maxThresholdScore&&(c=CallStrengthStatsConstants.maxThresholdScore);var d=Math.round((30-n-o-c)/6);this._videoUpStreamConnectionScore=d,this._videoFramesEncodingTimeArray=[],this._videoPacketSendDelayTimeArray=[],this._videoFramesSentArray=[],this._isVideoUpStreamAnalysed=!0}},_setVideoDownStreamConnectionStatsData:function(){}};var AdhocCallBridge={},ZCMediaDomUtil={},ZCPIPManager={},ZCMediaDialogs={},ZCWMSEventSync={};class AVCliqDimensions{constructor(t=0,e=0,n=0,i=0){this.xAxis=t,this.yAxis=e,this.width=n,this.height=i,this.margin=0}clone(){return new AVCliqDimensions(this.xAxis,this.yAxis,this.width,this.height)}setMargin(t){this.resetMargin(),this.margin=t,this._updateMargin()}resetMargin(){this.margin=-this.margin,this._updateMargin(),this.margin=0}_updateMargin(){this.xAxis+=this.margin,this.yAxis+=this.margin,this.width-=2*this.margin,this.height-=2*this.margin}moveAxis(t=0,e=0){this.xAxis+=t,this.yAxis+=e}resetAxis(){this.xAxis=0,this.yAxis=0}alterMeasurements(t=0,e=0){this.width=t,this.height=e}fitWidthOnAspectRatio(t){var e=this.width,n=this.height,i=e*t;i>e&&(i=e),this.width=i,this.height=i/t,this.xAxis+=(e-i)/2,this.yAxis+=(n-this.height)/2}}AdhocCallBridge={attach:function(t){var e=t.getAssociatedConferenceId(),n=ZCSmartConferenceImpl.getCurrentActiveSession();n&&n.getId()===e&&(n.subscribe(AdhocOneToOneCallHandler),t.subscribe(AdhocConferenceHandler))},detach:function(t){var e=t.getAssociatedConferenceId(),n=ZCSmartConferenceImpl.getCurrentActiveSession();n&&n.getId()===e&&(n.unSubscribe(),t.unSubscribe())},publish:function(t,e,n){t.hasSubscribed()&&t.getSubscribedHandler()[e](t,n.associatedSessionId,n)}},ZCMediaDomUtil={openFullScreen:function(t,e,n){if(t){var i=function(){"function"==typeof e&&e(t),"function"==typeof n&&(void 0!==t.onfullscreenchange?t.onfullscreenchange=function(e){n(e,document.fullscreenElement===t)}:void 0!==t.onMSFullscreenChange?t.onMSFullscreenChange=function(e){n(e,document.msFullscreenElement===t)}:void 0!==t.onmozfullscreenchange?t.onmozfullscreenchange=function(e){n(e,document.mozFullScreenElement===t)}:void 0!==t.onwebkitfullscreenchange&&(t.onwebkitfullscreenchange=function(e){n(e,document.webkitFullscreenElement===t)}))},a=(t.requestFullscreen||t.msRequestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullscreen).call(t);a?a.then(i):i()}},exitFullScreen:function(t,e){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement){var n=(document.exitFullscreen||document.msExitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen).call(document);"function"==typeof t&&(n?n.then(t):t())}else"function"==typeof e&&e()},getFullScreenElement:function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement},addLoadIcon:function(t){t.find("[av_async_loading]").length||(t.attr("style","pointer-events:none; text-decoration:none; color:transparent !important;"),t.prepend('<span av_async_loading class="reqprocess_anim"></span>'))},removeLoadIcon:function(t){t.length&&(t.removeAttr("style"),t.find("[av_async_loading]").remove())}},ZCPIPManager=function(){const t={pipOverlay:'<div class="avcliq-pip-container flexM" id="avcliq-pip-overlay">\n\t\t\t\t\t\t<div class="flexM fdirC avcliq-pip-card">\n\t\t\t\t\t\t    <div class="avcliq-pip-icon zcf-pip"></div>\n\t\t\t\t\t\t    <div class="avcliq-pip-btn-cont">\n\t\t\t\t\t\t    \t{{content}}\n\t\t\t\t\t\t        <div class="zcl-btn-xs zcl-btn-neg--primary mL10" {{custom_attribute}} purpose="exitPIP">{{btn_text}}</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>'};var e=void 0,n=void 0;return{isSupported:i,getPIPOverlay:function(e){return $WC.template.replace(t.pipOverlay,{$content:"avcliq.media.pip.active",$btn_text:"common.close",custom_attribute:e})},toggleCamInPIP:function(t){document.pictureInPictureElement&&a()&&navigator.mediaSession.setCameraActive(!t)},toggleMicInPIP:function(t){document.pictureInPictureElement&&a()&&navigator.mediaSession.setMicrophoneActive(!t)},paintCanvasAndOpenPip:async function(t,n,a,r){if($canvasElem=ZCJQuery(t),!i()||!t||!$canvasElem.is("canvas"))return;t.width=ZCMediaConstants.pip.windowRange.defaultWidth,t.height=ZCMediaConstants.pip.windowRange.defaultHeight,function(t,n){try{if(e)return;var i=`var paintInCanvasTimer;\n\t\t\t\t\t\t\tonmessage = function(e) {\n\t\t\t\t\t\t\t\tif(e.data == 'start') {\n\t\t\t\t\t\t\t\t\tclearInterval(paintInCanvasTimer);\n\t\t\t\t\t\t\t\t\tpaintInCanvasTimer = setInterval(function(){ postMessage('start pip'); },${ZCMediaConstants.pip.paintInterval});\t\t//NO I18N\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if(e.data == 'stop') {\n\t\t\t\t\t\t\t\t\tclearInterval(paintInCanvasTimer);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}`,a=new Blob([i]),o=window.URL.createObjectURL(a);(e=new Worker(o)).onmessage=function(e){t()},e.postMessage("start")}catch(t){s(),"function"==typeof n&&n()}}((function(){n()}));const c=t.getVideoElement(ZCMediaConstants.pip.videoFps);c.muted=!0,await c.play(),o(c,a,r)},openPictureInPicture:o,exitPictureInPicture:function(t,e){if(!(t=t||n))return;if(!document.pictureInPictureEnabled&&!t.webkitSupportsPresentationMode)return;var i=function(){"function"==typeof e&&e()};s(),"function"==typeof document.exitPictureInPicture?document.pictureInPictureElement?document.exitPictureInPicture().then(i):i():void 0!==t&&"function"==typeof t.webkitSetPresentationMode&&"picture-in-picture"===t.webkitPresentationMode&&(t.webkitSetPresentationMode("inline"),i())}};function i(){return document.pictureInPictureEnabled&&$ZCUtil.Browser.isChrome()}function a(){return $ZCUtil.Browser.isChrome()}function o(t,e,o={}){var s=ZCJQuery(t);if(i()&&t&&s.is("video")&&document.pictureInPictureElement!==t){var r=function(){"function"==typeof e&&e(t)},c=function(t,e){a()&&("function"==typeof o.onCamToggle&&(navigator.mediaSession.setCameraActive(!o.isVideoMuted()),navigator.mediaSession.setActionHandler("togglecamera",e?function(t){var e=o.isVideoMuted();o.onCamToggle(e),navigator.mediaSession.setCameraActive(e)}:null)),"function"==typeof o.onMicToggle&&(navigator.mediaSession.setMicrophoneActive(!o.isAudioMuted()),navigator.mediaSession.setActionHandler("togglemicrophone",e?function(){var t=o.isAudioMuted();o.onMicToggle(t),navigator.mediaSession.setMicrophoneActive(t)}:null)),"function"==typeof o.onHangup&&navigator.mediaSession.setActionHandler("hangup",e?function(){o.onHangup(),navigator.mediaSession.setMicrophoneActive(!1),navigator.mediaSession.setCameraActive(!1)}:null)),"function"==typeof o.onChange&&o.onChange(t,e)},d=function(t){"function"==typeof o.onResize&&o.onResize(t)};"function"==typeof t.requestPictureInPicture?(s.one("enterpictureinpicture",(function(t){t.currentTarget.setPIP(),c(t,!0),n=t.originalEvent.pictureInPictureWindow,"function"==typeof o.onResize&&n.addEventListener("resize",d)})),s.one("leavepictureinpicture",(function(t){t.currentTarget.resetPIP(),void 0!==n&&n.removeEventListener("resize",d),c(t,!1),n=void 0})),t.requestPictureInPicture().then(r)):"function"==typeof t.webkitSetPresentationMode&&(t.onwebkitpresentationmodechanged=function(e){c(e,"picture-in-picture"===t.webkitPresentationMode)},t.webkitSetPresentationMode("picture-in-picture"),r())}}function s(){e&&(e.postMessage("stop"),e.terminate(),e.onmessage=void 0,e=void 0)}}(),ZCPIPUtil={_pipImageCache:{},_pipIconContent:{Web:{library:"\ue911",native:"\uea3f"},Mobile:{library:"\ue90f",native:"\ue983"}},showPIPOverlay:function(t,e){t.append(ZCPIPManager.getPIPOverlay(e))},removePIPOverlay:function(t){t.find("#avcliq-pip-overlay").remove()},paintBackground:function(t,e,n){t.fillStyle=e,t.fillRect(n.xAxis,n.yAxis,n.width,n.height)},getIconContent:function(t,e){var n=this._pipIconContent[t];return n?e?n.library:n.native:""},paintMainBackground:function(t,e){var n=t.canvas,i={radius:60,xAxis:n.width/2+10,yAxis:n.height/2+10},a={radius:300,xAxis:n.width/2,yAxis:n.height/2},o=t.createRadialGradient(i.xAxis,i.yAxis,i.radius,a.xAxis,a.yAxis,a.radius);o.addColorStop(1,"#246378"),o.addColorStop(0,"#1d2f4f"),this.paintBackground(t,o,e)},paintEachVideoInPIP:function(t,e,n,i){if(i.setMargin(2),this.paintBackground(t,"rgba(0,0,0,0.4)",i),n.muted)this.paintMutedVideoInPIP(t,n.name,i);else{var a=e.find("video")[0];i.fitWidthOnAspectRatio(a.getAspectRatio()),n.mirror?this.mirrorAndPaintVideo(t,a,i):t.drawImage(a,i.xAxis,i.yAxis,i.width,i.height)}},drawText:function(t,e,n,i={}){var a=t.measureText(e).width,o=i.maxWidth||t.canvas.width;if(a>o){var s=(a-o)/t.measureText(e[e.length-1]).width;e=e.slice(0,e.length-s-4)+"..."}t.font=i.font||"bold 24px Lato",t.textAlign=i.align||"start",t.fillStyle=i.color||"#FFF",t.textBaseline=i.baseline||"alphabetic",t.fillText(e,n.xAxis,n.yAxis)},drawCircle:function(t,e,n){t.beginPath(),t.arc(e.xAxis,e.yAxis,n,0,2*Math.PI),t.fillStyle="rgba(0,0,0,0.4)",t.fill(),t.lineWidth=6,t.strokeStyle="#f3a83b",t.stroke()},drawUserImage:function(t,e,n,i,a){this.drawCircle(t,i,a);var o=this._pipImageCache[e];if(o){if("loading"===o.state||"error"===o.state)return void this.drawText(t,n,i,{align:"center",baseline:"middle",maxWidth:2*a});this.drawCircularImage(t,o.img,i,a)}else{this.drawText(t,n,i,{align:"center",baseline:"middle",maxWidth:2*a});var s=new Image;s.crossOrigin="anonymous",fetch(this.getCorsImageUrl(e),{credentials:"include"}).then(t=>t.blob()).then(t=>{s.src=URL.createObjectURL(t),this._pipImageCache[e].img=s,this._pipImageCache[e].state="loaded"}),s.onerror=()=>{this._pipImageCache[e].state="error"},this._pipImageCache[e]={img:void 0,state:"loading"}}},drawCircularImage:function(t,e,n,i){t.save(),t.clip();var a,o,s=e.naturalWidth/e.naturalHeight;e.naturalWidth<e.naturalHeight?o=(a=2*i)/s:a=(o=2*i)*s,t.imageSmoothingEnabled=!0,t.drawImage(e,n.xAxis-a/2,n.yAxis-o/2,a,o),t.restore()},getCorsImageUrl:function(t){return MediaUtil.BRIDGE.Users.getImgUrlById(t,"original")+"&domain="+window.location.host},paintMutedVideoInPIP:function(t,e,n){this.paintBackground(t,"rgba(0,0,0,0.4)",n.clone());var i=new AVCliqDimensions(n.xAxis+n.width/2,n.yAxis+n.height/2);this.drawText(t,e,i,{align:"center"})},mirrorAndPaintVideo:function(t,e,n){t.save(),t.scale(-1,1),t.drawImage(e,-1*(n.xAxis+n.width),n.yAxis,n.width,n.height),t.restore()},drawRoundedCornerRectangle:function(t,e,n,i,a){n="number"==typeof n?{tl:n,tr:n,br:n,bl:n}:{tl:0,tr:0,br:0,bl:0,...n},t.beginPath(),t.moveTo(e.xAxis+n.tl,e.yAxis),t.lineTo(e.xAxis+e.width-n.tr,e.yAxis),t.quadraticCurveTo(e.xAxis+e.width,e.yAxis,e.xAxis+e.width,e.yAxis+n.tr),t.lineTo(e.xAxis+e.width,e.yAxis+e.height-n.br),t.quadraticCurveTo(e.xAxis+e.width,e.yAxis+e.height,e.xAxis+e.width-n.br,e.yAxis+e.height),t.lineTo(e.xAxis+n.bl,e.yAxis+e.height),t.quadraticCurveTo(e.xAxis,e.yAxis+e.height,e.xAxis,e.yAxis+e.height-n.bl),t.lineTo(e.xAxis,e.yAxis+n.tl),t.quadraticCurveTo(e.xAxis,e.yAxis,e.xAxis+n.tl,e.yAxis),t.closePath(),i&&(t.fillStyle=i,t.fill()),a&&(t.strokeStyle=a,t.stroke())}},ZCMediaDialogs={showUDPBlockedInfo:function(){if(!$WC.$Win.isExist("udp_blocked_info")){var t=void 0!==MediaUtil.BRIDGE?MediaUtil.BRIDGE.ServerConstants.AV_UDP_IP_WHITELISTING_DOC:$zcg._AV_UDP_IP_WHITELISTING_DOC,e=void 0!==MediaUtil.BRIDGE?MediaUtil.BRIDGE.Constants._cssClasses:$zcg._cssClasses;MediaUtil.createDialog({id:"udp_blocked_info",version:2,class:"zcdalogbx zcbg_mask alert_dialog zc-av-device-switch-popup",headerhtml:$WC.$Dlg.frameHeaderHTML({header:MediaUtil.getResource("avcliq.media.udp.blocked.header")}),bodyhtml:$WC.$Dlg.frameBodyInfoHTML({info:[MediaUtil.getResource("avcliq.media.udp.blocked.info",["zc-av-hyperlink",t])]}),buttons:[$WC.$Dlg.getButtonObj(MediaUtil.getResource("common.okgotit"),e.SECONDARY_BTN)]},!0)}}},ZCWMSEventSync={_receivedEventIds:[],pushEventId:function(t){1e3===this._receivedEventIds.length&&this._receivedEventIds.shift(),t&&this._receivedEventIds.push(t)},isDuplicateEvent:function(t){return t&&this._receivedEventIds.includes(t)}};